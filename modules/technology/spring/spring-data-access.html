<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>spring data access | 克林</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="stylesheet" href="https://cdn.clinan.xyz/fontawesome.css">
    <meta name="description" content="生活、技术、摄影">
    
    <link rel="preload" href="/assets/css/0.styles.cc6be2d6.css" as="style"><link rel="preload" href="/assets/js/app.c387313f.js" as="script"><link rel="preload" href="/assets/js/2.07d632c5.js" as="script"><link rel="preload" href="/assets/js/71.79e7b907.js" as="script"><link rel="prefetch" href="/assets/js/10.7b164219.js"><link rel="prefetch" href="/assets/js/11.f26295a2.js"><link rel="prefetch" href="/assets/js/12.215e9bd1.js"><link rel="prefetch" href="/assets/js/13.916a1030.js"><link rel="prefetch" href="/assets/js/14.6ebe2f7d.js"><link rel="prefetch" href="/assets/js/15.99fd32fe.js"><link rel="prefetch" href="/assets/js/16.a701c814.js"><link rel="prefetch" href="/assets/js/17.031348b7.js"><link rel="prefetch" href="/assets/js/18.149256fc.js"><link rel="prefetch" href="/assets/js/19.e739899c.js"><link rel="prefetch" href="/assets/js/20.dcad2a56.js"><link rel="prefetch" href="/assets/js/21.057b7460.js"><link rel="prefetch" href="/assets/js/22.ce64e41c.js"><link rel="prefetch" href="/assets/js/23.daf19161.js"><link rel="prefetch" href="/assets/js/24.749d98a7.js"><link rel="prefetch" href="/assets/js/25.3a6551a2.js"><link rel="prefetch" href="/assets/js/26.67d5bf4f.js"><link rel="prefetch" href="/assets/js/27.d11f18f3.js"><link rel="prefetch" href="/assets/js/28.98119994.js"><link rel="prefetch" href="/assets/js/29.f81591b4.js"><link rel="prefetch" href="/assets/js/3.925378c0.js"><link rel="prefetch" href="/assets/js/30.3d37f95f.js"><link rel="prefetch" href="/assets/js/31.6ddfa063.js"><link rel="prefetch" href="/assets/js/32.6782db54.js"><link rel="prefetch" href="/assets/js/33.c32aacff.js"><link rel="prefetch" href="/assets/js/34.0d6b18cf.js"><link rel="prefetch" href="/assets/js/35.90fa8707.js"><link rel="prefetch" href="/assets/js/36.b75b717d.js"><link rel="prefetch" href="/assets/js/37.d5574023.js"><link rel="prefetch" href="/assets/js/38.9666c5d9.js"><link rel="prefetch" href="/assets/js/39.be9b8db9.js"><link rel="prefetch" href="/assets/js/4.c338ef74.js"><link rel="prefetch" href="/assets/js/40.0496212f.js"><link rel="prefetch" href="/assets/js/41.53f9abbe.js"><link rel="prefetch" href="/assets/js/42.48e3621f.js"><link rel="prefetch" href="/assets/js/43.ded57d48.js"><link rel="prefetch" href="/assets/js/44.027366a5.js"><link rel="prefetch" href="/assets/js/45.270bebde.js"><link rel="prefetch" href="/assets/js/46.5cb35b21.js"><link rel="prefetch" href="/assets/js/47.9df7131a.js"><link rel="prefetch" href="/assets/js/48.58499a70.js"><link rel="prefetch" href="/assets/js/49.ca61ec46.js"><link rel="prefetch" href="/assets/js/5.ee90145e.js"><link rel="prefetch" href="/assets/js/50.237e199e.js"><link rel="prefetch" href="/assets/js/51.f571cf97.js"><link rel="prefetch" href="/assets/js/52.57d87431.js"><link rel="prefetch" href="/assets/js/53.163cbc01.js"><link rel="prefetch" href="/assets/js/54.22559499.js"><link rel="prefetch" href="/assets/js/55.7620fc70.js"><link rel="prefetch" href="/assets/js/56.dd45b171.js"><link rel="prefetch" href="/assets/js/57.1edff986.js"><link rel="prefetch" href="/assets/js/58.6ddb12e0.js"><link rel="prefetch" href="/assets/js/59.8243df7f.js"><link rel="prefetch" href="/assets/js/6.049d604b.js"><link rel="prefetch" href="/assets/js/60.665f6dc9.js"><link rel="prefetch" href="/assets/js/61.13f75167.js"><link rel="prefetch" href="/assets/js/62.cf46bf76.js"><link rel="prefetch" href="/assets/js/63.0bbbaeeb.js"><link rel="prefetch" href="/assets/js/64.d8daf8e4.js"><link rel="prefetch" href="/assets/js/65.5075cbc9.js"><link rel="prefetch" href="/assets/js/66.dfb3c850.js"><link rel="prefetch" href="/assets/js/67.c9920c80.js"><link rel="prefetch" href="/assets/js/68.7ba3806a.js"><link rel="prefetch" href="/assets/js/69.4df1b72c.js"><link rel="prefetch" href="/assets/js/7.61da790d.js"><link rel="prefetch" href="/assets/js/70.f44691e5.js"><link rel="prefetch" href="/assets/js/72.76c7a030.js"><link rel="prefetch" href="/assets/js/73.15d46a8c.js"><link rel="prefetch" href="/assets/js/74.7da23b80.js"><link rel="prefetch" href="/assets/js/75.2ab83637.js"><link rel="prefetch" href="/assets/js/76.fb7ef46f.js"><link rel="prefetch" href="/assets/js/77.c462d8d1.js"><link rel="prefetch" href="/assets/js/78.378764eb.js"><link rel="prefetch" href="/assets/js/8.f851a47e.js"><link rel="prefetch" href="/assets/js/9.9d6d487d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cc6be2d6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://cdn.clinan.xyz/mini_logo.png" alt="克林" class="logo"> <span class="site-name can-hide">克林</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/modules/literature/" class="nav-link">现代文学</a></div><div class="nav-item"><a href="/modules/technology/" class="nav-link router-link-active">杂技奇谭</a></div><div class="nav-item"><a href="/modules/life/" class="nav-link">吃草日常</a></div><div class="nav-item"><a href="/modules/photography/" class="nav-link">无后期摄影</a></div> <a href="https://github.com/clinan/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/modules/literature/" class="nav-link">现代文学</a></div><div class="nav-item"><a href="/modules/technology/" class="nav-link router-link-active">杂技奇谭</a></div><div class="nav-item"><a href="/modules/life/" class="nav-link">吃草日常</a></div><div class="nav-item"><a href="/modules/photography/" class="nav-link">无后期摄影</a></div> <a href="https://github.com/clinan/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/modules/technology/" aria-current="page" class="sidebar-link">目录</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>架构</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Spring</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/modules/technology/spring/SPI启动.html" class="sidebar-link">Servlet SPI</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/technology/spring/SPI启动.html#_1-spring使用java配置servlet代码如下" class="sidebar-link">1. spring使用java配置Servlet代码如下</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/SPI启动.html#_2-spring的源码" class="sidebar-link">2. spring的源码</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/SPI启动.html#_3-tomcat源码" class="sidebar-link">3. tomcat源码</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/SPI启动.html#_4-springboot-war包启动" class="sidebar-link">4. springboot war包启动</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/SPI启动.html#_5-总结" class="sidebar-link">5. 总结</a></li></ul></li><li><a href="/modules/technology/spring/DispatcherServlet分析.html" class="sidebar-link">SpringDispatcherServlet分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/technology/spring/DispatcherServlet分析.html#_1、配置springservlet" class="sidebar-link">1、配置springServlet</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/DispatcherServlet分析.html#_2、dodispatcher" class="sidebar-link">2、doDispatcher</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/DispatcherServlet分析.html#_3、应用视图解析" class="sidebar-link">3、应用视图解析</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/DispatcherServlet分析.html#_4、拦截器" class="sidebar-link">4、拦截器</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/DispatcherServlet分析.html#_5、processdispatchresult" class="sidebar-link">5、processDispatchResult</a></li></ul></li><li><a href="/modules/technology/spring/springboot-autoconfigure.html" class="sidebar-link">springboot自动化配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/technology/spring/springboot-autoconfigure.html#enable相关注解" class="sidebar-link">Enable相关注解</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/springboot-autoconfigure.html#主要的注解" class="sidebar-link">主要的注解</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/springboot-autoconfigure.html#如何作用" class="sidebar-link">如何作用</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/springboot-autoconfigure.html#springboot-war包启动" class="sidebar-link">springboot war包启动</a></li></ul></li><li><a href="/modules/technology/spring/controller参数解析拦截.html" class="sidebar-link">spring参数注解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/technology/spring/controller参数解析拦截.html#思路" class="sidebar-link">思路</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/controller参数解析拦截.html#配置类" class="sidebar-link">配置类</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/controller参数解析拦截.html#请求拦截器-interceptor" class="sidebar-link">请求拦截器（Interceptor）</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/controller参数解析拦截.html#登录用户参数解析器" class="sidebar-link">登录用户参数解析器</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/controller参数解析拦截.html#测试示例" class="sidebar-link">测试示例</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/controller参数解析拦截.html#源码" class="sidebar-link">源码</a></li></ul></li><li><a href="/modules/technology/spring/springboot.html" class="sidebar-link">springBoot 启动流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/technology/spring/springboot.html#jar启动" class="sidebar-link">jar启动</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/springboot.html#tomcat启动-war" class="sidebar-link">tomcat启动(war)</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/springboot.html#webapplication的创建" class="sidebar-link">WebApplication的创建</a></li></ul></li><li><a href="/modules/technology/spring/spring-bean.html" class="sidebar-link">Spring-Bean</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/technology/spring/spring-bean.html#bean的生命周期" class="sidebar-link">bean的生命周期</a></li></ul></li><li><a href="/modules/technology/spring/springboot_init_flow.html" class="sidebar-link">springboot 的启动流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/technology/spring/springboot_init_flow.html#创建springapplication对象" class="sidebar-link">创建SpringApplication对象</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/springboot_init_flow.html#run" class="sidebar-link">run</a></li></ul></li><li><a href="/modules/technology/spring/spring-data-access.html" aria-current="page" class="active sidebar-link">spring data access</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/technology/spring/spring-data-access.html#jdbctemplate" class="sidebar-link">JdbcTemplate</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/spring-data-access.html#spring-orm-hibernate-mybatis" class="sidebar-link">spring-orm（hibernate mybatis）</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/spring-data-access.html#数据库连接池" class="sidebar-link">数据库连接池</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/spring-data-access.html#事务代码" class="sidebar-link">事务代码</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/spring-data-access.html#手写事务模板" class="sidebar-link">手写事务模板</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/spring-data-access.html#事务的传播性-propagation" class="sidebar-link">事务的传播性 Propagation</a></li></ul></li><li><a href="/modules/technology/spring/mybatis.html" class="sidebar-link">mybatis</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/technology/spring/mybatis.html#主要的类介绍" class="sidebar-link">主要的类介绍</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/mybatis.html#mapper文件加载" class="sidebar-link">mapper文件加载</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/mybatis.html#缓存" class="sidebar-link">缓存</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/mybatis.html#xml标签解析" class="sidebar-link">xml标签解析</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/mybatis.html#插件" class="sidebar-link">插件</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/mybatis.html#结果集处理" class="sidebar-link">结果集处理</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/mybatis.html#日志的打印" class="sidebar-link">日志的打印</a></li></ul></li><li><a href="/modules/technology/spring/spring-mvc.html" class="sidebar-link">SpringMVC的启动流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/technology/spring/spring-mvc.html#spring-context的启动" class="sidebar-link">spring-context的启动</a></li><li class="sidebar-sub-header"><a href="/modules/technology/spring/spring-mvc.html#spring调度器的启动" class="sidebar-link">spring调度器的启动</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringCloud</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux(Debian)</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="spring-data-access"><a href="#spring-data-access" class="header-anchor">#</a> spring data access</h1> <h2 id="jdbctemplate"><a href="#jdbctemplate" class="header-anchor">#</a> JdbcTemplate</h2> <p>jdbc里面的方法大多依赖于execute方法</p> <h3 id="_1-获取数据源"><a href="#_1-获取数据源" class="header-anchor">#</a> 1. 获取数据源</h3> <ul><li><p><code>JdbcTemplate#execute</code>方法</p> <p><code>Connection con = DataSourceUtils.getConnection(obtainDataSource());</code></p> <ul><li>获取数据源<code>org.springframework.jdbc.support.JdbcAccessor#obtainDataSource#obtainDataSource()</code> <ul><li>从Jdbc父类方法<code>JdbcAccessor#getDataSource</code>获取，这是本身就在jdbcTemplate对象中的数据源对象</li></ul></li> <li>在spring创建<code>JdbcTemplate</code>的bean的时候，由构造函数注入的。</li></ul></li></ul> <h3 id="_2-获取数据库连接connection"><a href="#_2-获取数据库连接connection" class="header-anchor">#</a> 2. 获取数据库连接Connection</h3> <ul><li><code>org.springframework.jdbc.datasource.DataSourceUtils#getConnection</code></li> <li><code>org.springframework.jdbc.datasource.DataSourceUtils#doGetConnection</code></li> <li>从当前事务同步管理器中获取ConnectionHolder：<code>ConnectionHolder conHolder = (ConnectionHolder) TransactionSynchronizationManager.getResource(dataSource);</code> <ul><li><code>TransactionSynchronizationManager#getResource</code> 从ThreadLocal中获取ConnectionHolder</li></ul></li> <li>如果ConnectHolder为空：<code>Connection con = fetchConnection(dataSource);</code> <ul><li><code>Connection con = dataSource.getConnection();</code></li></ul></li> <li>并通过<code>TransactionSynchronizationManager</code>设置到ThreadLocal中</li></ul> <h2 id="spring-orm-hibernate-mybatis"><a href="#spring-orm-hibernate-mybatis" class="header-anchor">#</a> spring-orm（hibernate mybatis）</h2> <ul><li>通过IOC配置Hibernate的SessionFactory，通过AOP封装Hibernate的事务。</li> <li>通用mapper的启动</li></ul> <h3 id="hibernate"><a href="#hibernate" class="header-anchor">#</a> hibernate</h3> <p>hibernate中SessionFactory的子类LocalSessionFactoryBean，用于构建SessionFactory。</p> <h3 id="mybatis"><a href="#mybatis" class="header-anchor">#</a> mybatis</h3> <ul><li>@MapperScan 使用@Import(MapperScannerRegistrar.class) 扫描mapper接口</li> <li><code>tk.mybatis.spring.mapper.ClassPathMapperScanner</code>实现mapper的扫描</li> <li>TODO 如何注入select Insert等方法</li></ul> <h2 id="数据库连接池"><a href="#数据库连接池" class="header-anchor">#</a> 数据库连接池</h2> <p>其实也是像数据库一样去配置，但是连接池会保持一定数量的connect，在getConnection的时候，直接返回现有的connection</p> <h1 id="spring-事务"><a href="#spring-事务" class="header-anchor">#</a> spring 事务</h1> <ul><li><p>通过<code>TransactionProxyFactoryBean</code>来使用AOP功能，可以生成代理对象。</p></li> <li><p><code>TransactionProxyFactoryBean</code>的父类<code>AbstractSingletonProxyFactoryBean</code>实现了接口<code>InitializingBean</code>,最后在<code>afterPropertiesSet</code>中调用了<code>createMainInterceptor()</code>方法</p></li> <li><p><code>createMainInterceptor()</code>方法<code>new TransactionAttributeSourceAdvisor</code>将拦截器<code>TransactionInterceptor</code>配置到AOP中</p></li> <li><p>在代理对象中，通过<code>TransactionInterceptor</code>来完成对代理方法的拦截</p> <ul><li><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionInterceptor</span> <span class="token keyword">extends</span> <span class="token class-name">TransactionAspectSupport</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span>
</code></pre></div></li> <li><p>可以看到<code>TransactionInterceptor</code>实现了AOP的<code>MethodInterceptor</code></p></li></ul></li> <li><p><code>TransactionProxyFactoryBean</code>创建了<code>TransactionInterceptor</code></p></li> <li><p><code>TransactionInterceptor</code>中的事务管理器<code>TransactionManager</code>第一次获取是从beanFactory中取得的</p></li> <li><p>事务的回滚或提交</p> <ul><li>AOP调用<code>TransactionInterceptor#invoke</code>方法</li> <li>调用父类的<code>TransactionAspectSupport#invokeWithinTransaction</code>处理提交和回滚</li></ul></li> <li><p><code>createTransactionIfNecessary</code>方法创建了两个对象<code>TransactionInfo</code>和<code>TransactionStatus</code></p></li> <li><p><code>AbstractPlatformTransactionManager#getTransaction</code>根据获取<code>TransactionStatus</code>,</p></li> <li><p><code>AbstractPlatformTransactionManager#handleExistingTransaction</code>已有事务，则执行这个方法</p></li> <li><p>事务挂起suspend</p></li></ul> <h2 id="事务代码"><a href="#事务代码" class="header-anchor">#</a> 事务代码</h2> <h3 id="invokewithintransaction"><a href="#invokewithintransaction" class="header-anchor">#</a> invokeWithinTransaction</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">invokeWithinTransaction</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">,</span>
			<span class="token keyword">final</span> <span class="token class-name">InvocationCallback</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>

		<span class="token comment">// If the transaction attribute is null, the method is non-transactional.</span>
		<span class="token class-name">TransactionAttributeSource</span> tas <span class="token operator">=</span> <span class="token function">getTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token class-name">TransactionAttribute</span> txAttr <span class="token operator">=</span> <span class="token punctuation">(</span>tas <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> tas<span class="token punctuation">.</span><span class="token function">getTransactionAttribute</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token class-name">TransactionManager</span> tm <span class="token operator">=</span> <span class="token function">determineTransactionManager</span><span class="token punctuation">(</span>txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reactiveAdapterRegistry <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> tm <span class="token keyword">instanceof</span> <span class="token class-name">ReactiveTransactionManager</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">boolean</span> isSuspendingFunction <span class="token operator">=</span> <span class="token class-name">KotlinDetector</span><span class="token punctuation">.</span><span class="token function">isSuspendingFunction</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">boolean</span> hasSuspendingFlowReturnType <span class="token operator">=</span> isSuspendingFunction <span class="token operator">&amp;&amp;</span>
					COROUTINES_FLOW_CLASS_NAME<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MethodParameter</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>isSuspendingFunction <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>invocation <span class="token keyword">instanceof</span> <span class="token class-name">CoroutinesInvocationCallback</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Coroutines invocation not supported: &quot;</span> <span class="token operator">+</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">CoroutinesInvocationCallback</span> corInv <span class="token operator">=</span> <span class="token punctuation">(</span>isSuspendingFunction <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">CoroutinesInvocationCallback</span><span class="token punctuation">)</span> invocation <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token class-name">ReactiveTransactionSupport</span> txSupport <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transactionSupportCache<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> key <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
				<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> reactiveType <span class="token operator">=</span>
						<span class="token punctuation">(</span>isSuspendingFunction <span class="token operator">?</span> <span class="token punctuation">(</span>hasSuspendingFlowReturnType <span class="token operator">?</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">:</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token operator">:</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">ReactiveAdapter</span> adapter <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveAdapterRegistry<span class="token punctuation">.</span><span class="token function">getAdapter</span><span class="token punctuation">(</span>reactiveType<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>adapter <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot apply reactive transaction to non-reactive return type: &quot;</span> <span class="token operator">+</span>
							method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveTransactionSupport</span><span class="token punctuation">(</span>adapter<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token class-name">InvocationCallback</span> callback <span class="token operator">=</span> invocation<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>corInv <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				callback <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">CoroutinesUtils</span><span class="token punctuation">.</span><span class="token function">invokeSuspendingFunction</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> corInv<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> corInv<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">Object</span> result <span class="token operator">=</span> txSupport<span class="token punctuation">.</span><span class="token function">invokeWithinTransaction</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">ReactiveTransactionManager</span><span class="token punctuation">)</span> tm<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>corInv <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">Publisher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> pr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Publisher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> result<span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token punctuation">(</span>hasSuspendingFlowReturnType <span class="token operator">?</span> <span class="token class-name">KotlinDelegate</span><span class="token punctuation">.</span><span class="token function">asFlow</span><span class="token punctuation">(</span>pr<span class="token punctuation">)</span> <span class="token operator">:</span>
						<span class="token class-name">KotlinDelegate</span><span class="token punctuation">.</span><span class="token function">awaitSingleOrNull</span><span class="token punctuation">(</span>pr<span class="token punctuation">,</span> corInv<span class="token punctuation">.</span><span class="token function">getContinuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> result<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token class-name">PlatformTransactionManager</span> ptm <span class="token operator">=</span> <span class="token function">asPlatformTransactionManager</span><span class="token punctuation">(</span>tm<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token class-name">String</span> joinpointIdentification <span class="token operator">=</span> <span class="token function">methodIdentification</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>ptm <span class="token keyword">instanceof</span> <span class="token class-name">CallbackPreferringPlatformTransactionManager</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ！！！！！！！！！！！！重要的代码，创建了两个对象TransactionInfo和TransactionStatus</span>
			<span class="token comment">// Standard transaction demarcation with getTransaction and commit/rollback calls.</span>
			<span class="token class-name">TransactionInfo</span> txInfo <span class="token operator">=</span> <span class="token function">createTransactionIfNecessary</span><span class="token punctuation">(</span>ptm<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> joinpointIdentification<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token class-name">Object</span> retVal<span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token comment">// This is an around advice: Invoke the next interceptor in the chain.</span>
				<span class="token comment">// This will normally result in a target object being invoked.</span>
				retVal <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceedWithInvocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// target invocation exception</span>
				<span class="token function">completeTransactionAfterThrowing</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">finally</span> <span class="token punctuation">{</span>
				<span class="token function">cleanupTransactionInfo</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>retVal <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> vavrPresent <span class="token operator">&amp;&amp;</span> <span class="token class-name">VavrDelegate</span><span class="token punctuation">.</span><span class="token function">isVavrTry</span><span class="token punctuation">(</span>retVal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// Set rollback-only in case of Vavr failure matching our rollback rules...</span>
				<span class="token class-name">TransactionStatus</span> status <span class="token operator">=</span> txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> txAttr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					retVal <span class="token operator">=</span> <span class="token class-name">VavrDelegate</span><span class="token punctuation">.</span><span class="token function">evaluateTryFailure</span><span class="token punctuation">(</span>retVal<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			<span class="token function">commitTransactionAfterReturning</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token class-name">Object</span> result<span class="token punctuation">;</span>
			<span class="token keyword">final</span> <span class="token class-name">ThrowableHolder</span> throwableHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThrowableHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// It's a CallbackPreferringPlatformTransactionManager: pass a TransactionCallback in.</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CallbackPreferringPlatformTransactionManager</span><span class="token punctuation">)</span> ptm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>txAttr<span class="token punctuation">,</span> status <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
					<span class="token class-name">TransactionInfo</span> txInfo <span class="token operator">=</span> <span class="token function">prepareTransactionInfo</span><span class="token punctuation">(</span>ptm<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> joinpointIdentification<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">try</span> <span class="token punctuation">{</span>
						<span class="token class-name">Object</span> retVal <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceedWithInvocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>retVal <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> vavrPresent <span class="token operator">&amp;&amp;</span> <span class="token class-name">VavrDelegate</span><span class="token punctuation">.</span><span class="token function">isVavrTry</span><span class="token punctuation">(</span>retVal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token comment">// Set rollback-only in case of Vavr failure matching our rollback rules...</span>
							retVal <span class="token operator">=</span> <span class="token class-name">VavrDelegate</span><span class="token punctuation">.</span><span class="token function">evaluateTryFailure</span><span class="token punctuation">(</span>retVal<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr<span class="token punctuation">.</span><span class="token function">rollbackOn</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token comment">// A RuntimeException: will lead to a rollback.</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
								<span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> ex<span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
							<span class="token keyword">else</span> <span class="token punctuation">{</span>
								<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ThrowableHolderException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">else</span> <span class="token punctuation">{</span>
							<span class="token comment">// A normal return value: will lead to a commit.</span>
							throwableHolder<span class="token punctuation">.</span>throwable <span class="token operator">=</span> ex<span class="token punctuation">;</span>
							<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">finally</span> <span class="token punctuation">{</span>
						<span class="token function">cleanupTransactionInfo</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ThrowableHolderException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSystemException</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>throwableHolder<span class="token punctuation">.</span>throwable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Application exception overridden by commit exception&quot;</span><span class="token punctuation">,</span> throwableHolder<span class="token punctuation">.</span>throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
					ex2<span class="token punctuation">.</span><span class="token function">initApplicationException</span><span class="token punctuation">(</span>throwableHolder<span class="token punctuation">.</span>throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">throw</span> ex2<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>throwableHolder<span class="token punctuation">.</span>throwable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Application exception overridden by commit exception&quot;</span><span class="token punctuation">,</span> throwableHolder<span class="token punctuation">.</span>throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">throw</span> ex2<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// Check result state: It might indicate a Throwable to rethrow.</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>throwableHolder<span class="token punctuation">.</span>throwable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">throw</span> throwableHolder<span class="token punctuation">.</span>throwable<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> result<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre></div><h3 id="gettransaction"><a href="#gettransaction" class="header-anchor">#</a> getTransaction</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 处理了事务的传播性</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">TransactionStatus</span> <span class="token function">getTransaction</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> <span class="token class-name">TransactionException</span> <span class="token punctuation">{</span>

		<span class="token comment">// Use defaults if no transaction definition given.</span>
		<span class="token class-name">TransactionDefinition</span> def <span class="token operator">=</span> <span class="token punctuation">(</span>definition <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> definition <span class="token operator">:</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">Object</span> transaction <span class="token operator">=</span> <span class="token function">doGetTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">boolean</span> debugEnabled <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExistingTransaction</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Existing transaction found -&gt; check propagation behavior to find out how to behave.</span>
			<span class="token keyword">return</span> <span class="token function">handleExistingTransaction</span><span class="token punctuation">(</span>def<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Check definition settings for new transaction.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>def<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>TIMEOUT_DEFAULT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidTimeoutException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid transaction timeout&quot;</span><span class="token punctuation">,</span> def<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// No existing transaction found -&gt; check propagation behavior to find out how to proceed.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>def<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_MANDATORY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalTransactionStateException</span><span class="token punctuation">(</span>
					<span class="token string">&quot;No existing transaction found for transaction marked with propagation 'mandatory'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>def<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_REQUIRED <span class="token operator">||</span>
				def<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_REQUIRES_NEW <span class="token operator">||</span>
				def<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_NESTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">SuspendedResourcesHolder</span> suspendedResources <span class="token operator">=</span> <span class="token function">suspend</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>debugEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Creating new transaction with name [&quot;</span> <span class="token operator">+</span> def<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]: &quot;</span> <span class="token operator">+</span> def<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span>def<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">resume</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// Create &quot;empty&quot; transaction: no actual transaction, but potentially synchronization.</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>def<span class="token punctuation">.</span><span class="token function">getIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>ISOLATION_DEFAULT <span class="token operator">&amp;&amp;</span> logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Custom isolation level specified but no actual transaction initiated; &quot;</span> <span class="token operator">+</span>
						<span class="token string">&quot;isolation level will effectively be ignored: &quot;</span> <span class="token operator">+</span> def<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">boolean</span> newSynchronization <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getTransactionSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> SYNCHRONIZATION_ALWAYS<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>def<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> newSynchronization<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre></div><h3 id="handleexistingtransaction"><a href="#handleexistingtransaction" class="header-anchor">#</a> handleExistingTransaction</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">TransactionStatus</span> <span class="token function">handleExistingTransaction</span><span class="token punctuation">(</span>
			<span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">,</span> <span class="token class-name">Object</span> transaction<span class="token punctuation">,</span> <span class="token keyword">boolean</span> debugEnabled<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> <span class="token class-name">TransactionException</span> <span class="token punctuation">{</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_NEVER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalTransactionStateException</span><span class="token punctuation">(</span>
					<span class="token string">&quot;Existing transaction found for transaction marked with propagation 'never'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 如果是事务传播时PROPAGATION_NOT_SUPPORTED，挂起之前的事务</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_NOT_SUPPORTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>debugEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Suspending current transaction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">Object</span> suspendedResources <span class="token operator">=</span> <span class="token function">suspend</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">boolean</span> newSynchronization <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getTransactionSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> SYNCHRONIZATION_ALWAYS<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>
					definition<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newSynchronization<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 如果是事务传播时PROPAGATION_REQUIRES_NEW，挂起之前的事务，然后再新起一个事务</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_REQUIRES_NEW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>debugEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Suspending current transaction, creating new transaction with name [&quot;</span> <span class="token operator">+</span>
						definition<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">SuspendedResourcesHolder</span> suspendedResources <span class="token operator">=</span> <span class="token function">suspend</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 创建新的事务</span>
				<span class="token keyword">return</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> beginEx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">resumeAfterBeginException</span><span class="token punctuation">(</span>transaction<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">,</span> beginEx<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">throw</span> beginEx<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 事务的传播行为是PROPAGATION_NESTED，创建用于嵌套事务的savePoint，用于回滚或提交</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_NESTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNestedTransactionAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NestedTransactionNotSupportedException</span><span class="token punctuation">(</span>
						<span class="token string">&quot;Transaction manager does not allow nested transactions by default - &quot;</span> <span class="token operator">+</span>
						<span class="token string">&quot;specify 'nestedTransactionAllowed' property with value 'true'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>debugEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Creating nested transaction with name [&quot;</span> <span class="token operator">+</span> definition<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">useSavepointForNestedTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// Create savepoint within existing Spring-managed transaction,</span>
				<span class="token comment">// through the SavepointManager API implemented by TransactionStatus.</span>
				<span class="token comment">// Usually uses JDBC 3.0 savepoints. Never activates Spring synchronization.</span>
				<span class="token class-name">DefaultTransactionStatus</span> status <span class="token operator">=</span>
						<span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				status<span class="token punctuation">.</span><span class="token function">createAndHoldSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> status<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">// Nested transaction through nested begin and commit/rollback calls.</span>
				<span class="token comment">// Usually only for JTA: Spring synchronization might get activated here</span>
				<span class="token comment">// in case of a pre-existing JTA transaction.</span>
				<span class="token keyword">return</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Assumably（大概） PROPAGATION_SUPPORTS or PROPAGATION_REQUIRED.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>debugEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Participating in existing transaction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValidateExistingTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>ISOLATION_DEFAULT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">Integer</span> currentIsolationLevel <span class="token operator">=</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">getCurrentTransactionIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>currentIsolationLevel <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> currentIsolationLevel <span class="token operator">!=</span> definition<span class="token punctuation">.</span><span class="token function">getIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token class-name">Constants</span> isoConstants <span class="token operator">=</span> <span class="token class-name">DefaultTransactionDefinition</span><span class="token punctuation">.</span>constants<span class="token punctuation">;</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalTransactionStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Participating transaction with definition [&quot;</span> <span class="token operator">+</span>
							definition <span class="token operator">+</span> <span class="token string">&quot;] specifies isolation level which is incompatible with existing transaction: &quot;</span> <span class="token operator">+</span>
							<span class="token punctuation">(</span>currentIsolationLevel <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span>
									isoConstants<span class="token punctuation">.</span><span class="token function">toCode</span><span class="token punctuation">(</span>currentIsolationLevel<span class="token punctuation">,</span> <span class="token class-name">DefaultTransactionDefinition</span><span class="token punctuation">.</span>PREFIX_ISOLATION<span class="token punctuation">)</span> <span class="token operator">:</span>
									<span class="token string">&quot;(unknown)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>definition<span class="token punctuation">.</span><span class="token function">isReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isCurrentTransactionReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalTransactionStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Participating transaction with definition [&quot;</span> <span class="token operator">+</span>
							definition <span class="token operator">+</span> <span class="token string">&quot;] is not marked as read-only but existing transaction is&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">boolean</span> newSynchronization <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getTransactionSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> SYNCHRONIZATION_NEVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newSynchronization<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><h3 id="suspend"><a href="#suspend" class="header-anchor">#</a> suspend</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">SuspendedResourcesHolder</span> <span class="token function">suspend</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> transaction<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isSynchronizationActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSynchronization</span><span class="token punctuation">&gt;</span></span> suspendedSynchronizations <span class="token operator">=</span> <span class="token function">doSuspendSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token class-name">Object</span> suspendedResources <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>transaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					suspendedResources <span class="token operator">=</span> <span class="token function">doSuspend</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
                <span class="token comment">// 在这里保存线程中与事务有关的信息，并重置线程中相关的ThreadLocal变量</span>
				<span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">getCurrentTransactionName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">boolean</span> readOnly <span class="token operator">=</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isCurrentTransactionReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionReadOnly</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">Integer</span> isolationLevel <span class="token operator">=</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">getCurrentTransactionIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionIsolationLevel</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">boolean</span> wasActive <span class="token operator">=</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isActualTransactionActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setActualTransactionActive</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuspendedResourcesHolder</span><span class="token punctuation">(</span>
						suspendedResources<span class="token punctuation">,</span> suspendedSynchronizations<span class="token punctuation">,</span> name<span class="token punctuation">,</span> readOnly<span class="token punctuation">,</span> isolationLevel<span class="token punctuation">,</span> wasActive<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// doSuspend failed - original transaction is still active...</span>
				<span class="token function">doResumeSynchronization</span><span class="token punctuation">(</span>suspendedSynchronizations<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>transaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Transaction active but no synchronization active.</span>
			<span class="token class-name">Object</span> suspendedResources <span class="token operator">=</span> <span class="token function">doSuspend</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuspendedResourcesHolder</span><span class="token punctuation">(</span>suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// Neither transaction nor synchronization active.</span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre></div><h2 id="手写事务模板"><a href="#手写事务模板" class="header-anchor">#</a> 手写事务模板</h2> <h2 id="事务的传播性-propagation"><a href="#事务的传播性-propagation" class="header-anchor">#</a> 事务的传播性 Propagation</h2> <h4 id="required"><a href="#required" class="header-anchor">#</a> REQUIRED</h4> <p>默认事务级别，存在事务则加入而不创建，不存在则创建事务</p> <h4 id="supports"><a href="#supports" class="header-anchor">#</a> SUPPORTS</h4> <p>如果当前已经存在事务，那么加入该事务，否则以无事务运行</p> <h4 id="mandatory"><a href="#mandatory" class="header-anchor">#</a> MANDATORY</h4> <p>如果没有事务，会抛出异常。autocommit=true有用</p> <h4 id="requires-new"><a href="#requires-new" class="header-anchor">#</a> REQUIRES_NEW</h4> <p>Create a new transaction, suspending the current transaction if one exists. Analogous to the EJB transaction attribute of the same name. 创建一个新的事务，如果当前有事务存在，则挂起之前的事务</p> <h4 id="not-supported"><a href="#not-supported" class="header-anchor">#</a> NOT_SUPPORTED</h4> <p>不支持事务，如果当前有事务存在，则挂起之前的事务。</p> <h4 id="never"><a href="#never" class="header-anchor">#</a> NEVER</h4> <p>Do not support a current transaction; throw an exception if a current transaction exists.</p> <p>不支持事务，如果有事务已存在，则抛出异常</p> <h4 id="nested"><a href="#nested" class="header-anchor">#</a> NESTED</h4> <p>Execute within a nested transaction if a current transaction exists, behave like PROPAGATION_REQUIRED otherwise. There is no analogous feature in EJB.</p> <p>嵌套事务，创建保存点<code>savePoint</code>，只部分提交或回滚。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/clinan/blog/edit/master/modules/technology/spring/spring-data-access.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新于:</span> <span class="time">6/19/2021, 2:24:48 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/modules/technology/spring/springboot_init_flow.html" class="prev">springboot 的启动流程</a></span> <span class="next"><a href="/modules/technology/spring/mybatis.html">mybatis</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c387313f.js" defer></script><script src="/assets/js/2.07d632c5.js" defer></script><script src="/assets/js/71.79e7b907.js" defer></script>
  </body>
</html>
