<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>限流算法 | 克林</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="stylesheet" href="https://cdn.clinan.xyz/fontawesome.css">
    <meta name="description" content="生活、技术、摄影">
    
    <link rel="preload" href="/assets/css/0.styles.cc6be2d6.css" as="style"><link rel="preload" href="/assets/js/app.c387313f.js" as="script"><link rel="preload" href="/assets/js/2.07d632c5.js" as="script"><link rel="preload" href="/assets/js/36.b75b717d.js" as="script"><link rel="prefetch" href="/assets/js/10.7b164219.js"><link rel="prefetch" href="/assets/js/11.f26295a2.js"><link rel="prefetch" href="/assets/js/12.215e9bd1.js"><link rel="prefetch" href="/assets/js/13.916a1030.js"><link rel="prefetch" href="/assets/js/14.6ebe2f7d.js"><link rel="prefetch" href="/assets/js/15.99fd32fe.js"><link rel="prefetch" href="/assets/js/16.a701c814.js"><link rel="prefetch" href="/assets/js/17.031348b7.js"><link rel="prefetch" href="/assets/js/18.149256fc.js"><link rel="prefetch" href="/assets/js/19.e739899c.js"><link rel="prefetch" href="/assets/js/20.dcad2a56.js"><link rel="prefetch" href="/assets/js/21.057b7460.js"><link rel="prefetch" href="/assets/js/22.ce64e41c.js"><link rel="prefetch" href="/assets/js/23.daf19161.js"><link rel="prefetch" href="/assets/js/24.749d98a7.js"><link rel="prefetch" href="/assets/js/25.3a6551a2.js"><link rel="prefetch" href="/assets/js/26.67d5bf4f.js"><link rel="prefetch" href="/assets/js/27.d11f18f3.js"><link rel="prefetch" href="/assets/js/28.98119994.js"><link rel="prefetch" href="/assets/js/29.f81591b4.js"><link rel="prefetch" href="/assets/js/3.925378c0.js"><link rel="prefetch" href="/assets/js/30.3d37f95f.js"><link rel="prefetch" href="/assets/js/31.6ddfa063.js"><link rel="prefetch" href="/assets/js/32.6782db54.js"><link rel="prefetch" href="/assets/js/33.c32aacff.js"><link rel="prefetch" href="/assets/js/34.0d6b18cf.js"><link rel="prefetch" href="/assets/js/35.90fa8707.js"><link rel="prefetch" href="/assets/js/37.d5574023.js"><link rel="prefetch" href="/assets/js/38.9666c5d9.js"><link rel="prefetch" href="/assets/js/39.be9b8db9.js"><link rel="prefetch" href="/assets/js/4.c338ef74.js"><link rel="prefetch" href="/assets/js/40.0496212f.js"><link rel="prefetch" href="/assets/js/41.53f9abbe.js"><link rel="prefetch" href="/assets/js/42.48e3621f.js"><link rel="prefetch" href="/assets/js/43.ded57d48.js"><link rel="prefetch" href="/assets/js/44.027366a5.js"><link rel="prefetch" href="/assets/js/45.270bebde.js"><link rel="prefetch" href="/assets/js/46.5cb35b21.js"><link rel="prefetch" href="/assets/js/47.9df7131a.js"><link rel="prefetch" href="/assets/js/48.58499a70.js"><link rel="prefetch" href="/assets/js/49.ca61ec46.js"><link rel="prefetch" href="/assets/js/5.ee90145e.js"><link rel="prefetch" href="/assets/js/50.237e199e.js"><link rel="prefetch" href="/assets/js/51.f571cf97.js"><link rel="prefetch" href="/assets/js/52.57d87431.js"><link rel="prefetch" href="/assets/js/53.163cbc01.js"><link rel="prefetch" href="/assets/js/54.22559499.js"><link rel="prefetch" href="/assets/js/55.7620fc70.js"><link rel="prefetch" href="/assets/js/56.dd45b171.js"><link rel="prefetch" href="/assets/js/57.1edff986.js"><link rel="prefetch" href="/assets/js/58.6ddb12e0.js"><link rel="prefetch" href="/assets/js/59.8243df7f.js"><link rel="prefetch" href="/assets/js/6.049d604b.js"><link rel="prefetch" href="/assets/js/60.665f6dc9.js"><link rel="prefetch" href="/assets/js/61.13f75167.js"><link rel="prefetch" href="/assets/js/62.cf46bf76.js"><link rel="prefetch" href="/assets/js/63.0bbbaeeb.js"><link rel="prefetch" href="/assets/js/64.d8daf8e4.js"><link rel="prefetch" href="/assets/js/65.5075cbc9.js"><link rel="prefetch" href="/assets/js/66.dfb3c850.js"><link rel="prefetch" href="/assets/js/67.c9920c80.js"><link rel="prefetch" href="/assets/js/68.7ba3806a.js"><link rel="prefetch" href="/assets/js/69.4df1b72c.js"><link rel="prefetch" href="/assets/js/7.61da790d.js"><link rel="prefetch" href="/assets/js/70.f44691e5.js"><link rel="prefetch" href="/assets/js/71.79e7b907.js"><link rel="prefetch" href="/assets/js/72.76c7a030.js"><link rel="prefetch" href="/assets/js/73.15d46a8c.js"><link rel="prefetch" href="/assets/js/74.7da23b80.js"><link rel="prefetch" href="/assets/js/75.2ab83637.js"><link rel="prefetch" href="/assets/js/76.fb7ef46f.js"><link rel="prefetch" href="/assets/js/77.c462d8d1.js"><link rel="prefetch" href="/assets/js/78.378764eb.js"><link rel="prefetch" href="/assets/js/8.f851a47e.js"><link rel="prefetch" href="/assets/js/9.9d6d487d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cc6be2d6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://cdn.clinan.xyz/mini_logo.png" alt="克林" class="logo"> <span class="site-name can-hide">克林</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/modules/literature/" class="nav-link">现代文学</a></div><div class="nav-item"><a href="/modules/technology/" class="nav-link router-link-active">杂技奇谭</a></div><div class="nav-item"><a href="/modules/life/" class="nav-link">吃草日常</a></div><div class="nav-item"><a href="/modules/photography/" class="nav-link">无后期摄影</a></div> <a href="https://github.com/clinan/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/modules/literature/" class="nav-link">现代文学</a></div><div class="nav-item"><a href="/modules/technology/" class="nav-link router-link-active">杂技奇谭</a></div><div class="nav-item"><a href="/modules/life/" class="nav-link">吃草日常</a></div><div class="nav-item"><a href="/modules/photography/" class="nav-link">无后期摄影</a></div> <a href="https://github.com/clinan/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/modules/technology/" aria-current="page" class="sidebar-link">目录</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>架构</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/modules/technology/architecture/alibaba_book.html" class="sidebar-link">阿里亿级高并发系统设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/technology/architecture/alibaba_book.html#数据库" class="sidebar-link">数据库</a></li><li class="sidebar-sub-header"><a href="/modules/technology/architecture/alibaba_book.html#缓存" class="sidebar-link">缓存</a></li><li class="sidebar-sub-header"><a href="/modules/technology/architecture/alibaba_book.html#消息队列" class="sidebar-link">消息队列</a></li></ul></li><li><a href="/modules/technology/architecture/shortner_url.html" class="sidebar-link">短地址生成</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/technology/architecture/shortner_url.html#长地址映射到一个唯一的id" class="sidebar-link">长地址映射到一个唯一的id</a></li><li class="sidebar-sub-header"><a href="/modules/technology/architecture/shortner_url.html#如何实现短网址到长网址的映射-长到短的映射" class="sidebar-link">如何实现短网址到长网址的映射/ 长到短的映射</a></li><li class="sidebar-sub-header"><a href="/modules/technology/architecture/shortner_url.html#跳转用301还是302" class="sidebar-link">跳转用301还是302</a></li></ul></li><li><a href="/modules/technology/architecture/cache.html" class="sidebar-link">缓存</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/technology/architecture/cache.html#缓存读写-缓存一致性" class="sidebar-link">缓存读写（缓存一致性）</a></li><li class="sidebar-sub-header"><a href="/modules/technology/architecture/cache.html#缓存的高可用" class="sidebar-link">缓存的高可用</a></li><li class="sidebar-sub-header"><a href="/modules/technology/architecture/cache.html#缓存问题" class="sidebar-link">缓存问题</a></li></ul></li><li><a href="/modules/technology/architecture/limit.html" aria-current="page" class="active sidebar-link">限流算法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/technology/architecture/limit.html#计数器-固定窗口-算法" class="sidebar-link">计数器（固定窗口）算法</a></li><li class="sidebar-sub-header"><a href="/modules/technology/architecture/limit.html#滑动窗口算法" class="sidebar-link">滑动窗口算法</a></li><li class="sidebar-sub-header"><a href="/modules/technology/architecture/limit.html#漏斗算法" class="sidebar-link">漏斗算法</a></li><li class="sidebar-sub-header"><a href="/modules/technology/architecture/limit.html#令牌桶算法" class="sidebar-link">令牌桶算法</a></li><li class="sidebar-sub-header"><a href="/modules/technology/architecture/limit.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/modules/technology/architecture/consensus.html" class="sidebar-link">共识算法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/technology/architecture/consensus.html#paxos" class="sidebar-link">Paxos</a></li><li class="sidebar-sub-header"><a href="/modules/technology/architecture/consensus.html#multi-paxos" class="sidebar-link">Multi paxos</a></li><li class="sidebar-sub-header"><a href="/modules/technology/architecture/consensus.html#raft" class="sidebar-link">raft</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringCloud</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux(Debian)</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="限流算法"><a href="#限流算法" class="header-anchor">#</a> 限流算法</h1> <p><a href="https://blog.csdn.net/weixin_41846320/article/details/95941361" target="_blank" rel="noopener noreferrer">转载自<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="计数器-固定窗口-算法"><a href="#计数器-固定窗口-算法" class="header-anchor">#</a> 计数器（固定窗口）算法</h2> <p>计数器算法是使用计数器在周期内累加访问次数，当达到设定的限流值的时候，触发限流策略。下一个周期开始时，清零并重新计数。</p> <h3 id="优点"><a href="#优点" class="header-anchor">#</a> 优点</h3> <p>此算法无论是单机还是分布式情况下实现都非常简单，使用redis的incr原子自增性和线程安全就可以轻松实现。</p> <h3 id="缺点"><a href="#缺点" class="header-anchor">#</a> 缺点</h3> <p>这个算法通常用于QPS限流和统计总访问量，对于秒级以上的时间周期来说，会存在一个非常严重的临界问题。</p> <p><img src="https://img-blog.csdnimg.cn/20190716091413825.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTg0NjMyMA==,size_16,color_FFFFFF,t_70" alt=""></p> <p>假设一分钟内服务器的负载能力为100，因此一个周期的访问量限制在100，然而在第一个周期的最后5秒和下一个周期的开始5秒时间段内，分别涌入100的访问量，虽然没有超过那个周期的限制量，但是整体上10秒内已达到200的访问量，超过了服务器的负载能力。因此计数器算法方式限流对于周期比较长的限流，存在很大的弊端。</p> <h2 id="滑动窗口算法"><a href="#滑动窗口算法" class="header-anchor">#</a> 滑动窗口算法</h2> <p>滑动窗口算法是将时间周期分为N个小周期，分别记录每个小周期内访问次数，并且根据时间滑动删除过期的小周期。</p> <p>如下图，假设时间周期为1min，将1min再分为2个小周期，统计每个小周期的访问数量，则可以看到，第一个时间周期内，访问数量75，第二个为100，超过100的访问则被限流掉。</p> <p><img src="https://img-blog.csdnimg.cn/20190716091612718.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTg0NjMyMA==,size_16,color_FFFFFF,t_70" alt=""></p> <h3 id="特点"><a href="#特点" class="header-anchor">#</a> 特点</h3> <ol><li>避免了计数器固定窗口算法固定窗口切换时可能会产生两倍于阈值流量请求的问题；</li> <li>和漏斗算法相比，新来的请求也能够被处理到，避免了漏斗算法的饥饿问题。</li></ol> <h2 id="漏斗算法"><a href="#漏斗算法" class="header-anchor">#</a> 漏斗算法</h2> <p>漏斗算法是在请求到达时，将请求全部放入到漏斗中，如果达到上限，则直接丢弃（限流）。然后漏斗始终以恒定的速率将请求流出进行处理，从而达到平滑流量的作用。</p> <p><img src="https://img-blog.csdnimg.cn/20190716090944456.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTg0NjMyMA==,size_16,color_FFFFFF,t_70" alt=""></p> <h3 id="特点-2"><a href="#特点-2" class="header-anchor">#</a> 特点</h3> <p><strong>漏桶的漏出速率是固定的，可以起到整流的作用</strong>。即虽然请求的流量可能具有随机性,忽大忽小，但是经过漏斗算法之后，变成了有固定速率的稳定流量，从而对下游的系统起到保护作用。</p> <p><strong>不能解决流量突发的问题</strong>。还是拿刚刚测试的例子，我们设定的漏斗速率是2个/秒，然后突然来了10个请求，受限于漏斗的容量，只有5个请求被接受，另外5个被拒绝。你可能会说，漏斗速率是2个/秒，然后瞬间接受了5个请求，这不就解决了流量突发的问题吗？不，这5个请求只是被接受了，但是没有马上被处理，处理的速度仍然是我们设定的2个/秒，所以没有解决流量突发的问题。而接下来我们要谈的令牌桶算法能够在一定程度上解决流量突发的问题。</p> <h2 id="令牌桶算法"><a href="#令牌桶算法" class="header-anchor">#</a> 令牌桶算法</h2> <p>令牌桶算法是对漏斗算法的一种改进，除了能够起到限流的作用外，还允许一定程度的流量突发。</p> <p>在令牌桶算法中，存在一个令牌桶，算法中存在一种机制以恒定的速率向令牌桶中放入令牌。令牌桶也有一定的容量，如果满了令牌就无法放进去了。当请求到达时，会首先到令牌桶中去拿令牌，如果拿到了令牌，则该请求会被处理，并消耗掉拿到的令牌；如果令牌桶为空，则请求会被丢弃。</p> <p><img src="https://img-blog.csdnimg.cn/20190716090944463.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTg0NjMyMA==,size_16,color_FFFFFF,t_70" alt=""></p> <h3 id="特点分析"><a href="#特点分析" class="header-anchor">#</a> 特点分析</h3> <p>令牌桶算法是对漏桶算法的一种改进，除了能够在限制调用的平均速率的同时还允许一定程度的流量突发。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>对上述四种限流算法进行一下简单的总结。</p> <p><strong>计数器固定窗口算法</strong>实现简单，容易理解。和漏斗算法相比，新来的请求也能够被马上处理到。但是流量曲线可能不够平滑，有“突刺现象”，在窗口切换时可能会产生两倍于阈值流量的请求。</p> <p><strong>计数器滑动窗口算法</strong>作为计数器固定窗口算法的一种改进，有效解决了窗口切换时可能会产生两倍于阈值流量请求的问题。</p> <p><strong>漏斗算法</strong>能够对流量起到整流的作用，让随机不稳定的流量以固定的速率流出，但是不能解决<strong>流量突发</strong>的问题。</p> <p><strong>令牌桶算法</strong>作为漏斗算法的一种改进，除了能够起到平滑流量的作用，还允许一定程度的流量突发。</p> <p>以上四种限流算法都有自身的特点，具体使用时还是要结合自身的场景进行选取，<strong>没有最好的算法，只有最合适的算法</strong>。比如令牌桶算法一般用于保护自身的系统，对调用者进行限流，保护自身的系统不被突发的流量打垮。如果自身的系统实际的处理能力强于配置的流量限制时，可以允许一定程度的流量突发，使得实际的处理速率高于配置的速率，充分利用系统资源。</p> <p>而漏斗算法一般用于<strong>保护第三方</strong>的系统，比如自身的系统需要调用第三方的接口，为了保护第三方的系统不被自身的调用打垮，便可以通过漏斗算法进行限流，保证自身的流量平稳的打到第三方的接口上。 算法是死的，而算法中的<strong>思想精髓</strong>才是值得我们学习的。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/clinan/blog/edit/master/modules/technology/architecture/limit.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新于:</span> <span class="time">8/15/2021, 1:49:07 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/modules/technology/architecture/cache.html" class="prev">缓存</a></span> <span class="next"><a href="/modules/technology/architecture/consensus.html">共识算法</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c387313f.js" defer></script><script src="/assets/js/2.07d632c5.js" defer></script><script src="/assets/js/36.b75b717d.js" defer></script>
  </body>
</html>
