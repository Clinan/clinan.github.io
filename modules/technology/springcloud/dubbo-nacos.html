<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Dubbo源码解析 | 克林</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="stylesheet" href="https://cdn.clinan.xyz/fontawesome.css">
    <meta name="description" content="生活、技术、摄影">
    
    <link rel="preload" href="/assets/css/0.styles.cc6be2d6.css" as="style"><link rel="preload" href="/assets/js/app.c387313f.js" as="script"><link rel="preload" href="/assets/js/2.07d632c5.js" as="script"><link rel="preload" href="/assets/js/76.fb7ef46f.js" as="script"><link rel="prefetch" href="/assets/js/10.7b164219.js"><link rel="prefetch" href="/assets/js/11.f26295a2.js"><link rel="prefetch" href="/assets/js/12.215e9bd1.js"><link rel="prefetch" href="/assets/js/13.916a1030.js"><link rel="prefetch" href="/assets/js/14.6ebe2f7d.js"><link rel="prefetch" href="/assets/js/15.99fd32fe.js"><link rel="prefetch" href="/assets/js/16.a701c814.js"><link rel="prefetch" href="/assets/js/17.031348b7.js"><link rel="prefetch" href="/assets/js/18.149256fc.js"><link rel="prefetch" href="/assets/js/19.e739899c.js"><link rel="prefetch" href="/assets/js/20.dcad2a56.js"><link rel="prefetch" href="/assets/js/21.057b7460.js"><link rel="prefetch" href="/assets/js/22.ce64e41c.js"><link rel="prefetch" href="/assets/js/23.daf19161.js"><link rel="prefetch" href="/assets/js/24.749d98a7.js"><link rel="prefetch" href="/assets/js/25.3a6551a2.js"><link rel="prefetch" href="/assets/js/26.67d5bf4f.js"><link rel="prefetch" href="/assets/js/27.d11f18f3.js"><link rel="prefetch" href="/assets/js/28.98119994.js"><link rel="prefetch" href="/assets/js/29.f81591b4.js"><link rel="prefetch" href="/assets/js/3.925378c0.js"><link rel="prefetch" href="/assets/js/30.3d37f95f.js"><link rel="prefetch" href="/assets/js/31.6ddfa063.js"><link rel="prefetch" href="/assets/js/32.6782db54.js"><link rel="prefetch" href="/assets/js/33.c32aacff.js"><link rel="prefetch" href="/assets/js/34.0d6b18cf.js"><link rel="prefetch" href="/assets/js/35.90fa8707.js"><link rel="prefetch" href="/assets/js/36.b75b717d.js"><link rel="prefetch" href="/assets/js/37.d5574023.js"><link rel="prefetch" href="/assets/js/38.9666c5d9.js"><link rel="prefetch" href="/assets/js/39.be9b8db9.js"><link rel="prefetch" href="/assets/js/4.c338ef74.js"><link rel="prefetch" href="/assets/js/40.0496212f.js"><link rel="prefetch" href="/assets/js/41.53f9abbe.js"><link rel="prefetch" href="/assets/js/42.48e3621f.js"><link rel="prefetch" href="/assets/js/43.ded57d48.js"><link rel="prefetch" href="/assets/js/44.027366a5.js"><link rel="prefetch" href="/assets/js/45.270bebde.js"><link rel="prefetch" href="/assets/js/46.5cb35b21.js"><link rel="prefetch" href="/assets/js/47.9df7131a.js"><link rel="prefetch" href="/assets/js/48.58499a70.js"><link rel="prefetch" href="/assets/js/49.ca61ec46.js"><link rel="prefetch" href="/assets/js/5.ee90145e.js"><link rel="prefetch" href="/assets/js/50.237e199e.js"><link rel="prefetch" href="/assets/js/51.f571cf97.js"><link rel="prefetch" href="/assets/js/52.57d87431.js"><link rel="prefetch" href="/assets/js/53.163cbc01.js"><link rel="prefetch" href="/assets/js/54.22559499.js"><link rel="prefetch" href="/assets/js/55.7620fc70.js"><link rel="prefetch" href="/assets/js/56.dd45b171.js"><link rel="prefetch" href="/assets/js/57.1edff986.js"><link rel="prefetch" href="/assets/js/58.6ddb12e0.js"><link rel="prefetch" href="/assets/js/59.8243df7f.js"><link rel="prefetch" href="/assets/js/6.049d604b.js"><link rel="prefetch" href="/assets/js/60.665f6dc9.js"><link rel="prefetch" href="/assets/js/61.13f75167.js"><link rel="prefetch" href="/assets/js/62.cf46bf76.js"><link rel="prefetch" href="/assets/js/63.0bbbaeeb.js"><link rel="prefetch" href="/assets/js/64.d8daf8e4.js"><link rel="prefetch" href="/assets/js/65.5075cbc9.js"><link rel="prefetch" href="/assets/js/66.dfb3c850.js"><link rel="prefetch" href="/assets/js/67.c9920c80.js"><link rel="prefetch" href="/assets/js/68.7ba3806a.js"><link rel="prefetch" href="/assets/js/69.4df1b72c.js"><link rel="prefetch" href="/assets/js/7.61da790d.js"><link rel="prefetch" href="/assets/js/70.f44691e5.js"><link rel="prefetch" href="/assets/js/71.79e7b907.js"><link rel="prefetch" href="/assets/js/72.76c7a030.js"><link rel="prefetch" href="/assets/js/73.15d46a8c.js"><link rel="prefetch" href="/assets/js/74.7da23b80.js"><link rel="prefetch" href="/assets/js/75.2ab83637.js"><link rel="prefetch" href="/assets/js/77.c462d8d1.js"><link rel="prefetch" href="/assets/js/78.378764eb.js"><link rel="prefetch" href="/assets/js/8.f851a47e.js"><link rel="prefetch" href="/assets/js/9.9d6d487d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cc6be2d6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://cdn.clinan.xyz/mini_logo.png" alt="克林" class="logo"> <span class="site-name can-hide">克林</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/modules/literature/" class="nav-link">现代文学</a></div><div class="nav-item"><a href="/modules/technology/" class="nav-link router-link-active">杂技奇谭</a></div><div class="nav-item"><a href="/modules/life/" class="nav-link">吃草日常</a></div><div class="nav-item"><a href="/modules/photography/" class="nav-link">无后期摄影</a></div> <a href="https://github.com/clinan/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/modules/literature/" class="nav-link">现代文学</a></div><div class="nav-item"><a href="/modules/technology/" class="nav-link router-link-active">杂技奇谭</a></div><div class="nav-item"><a href="/modules/life/" class="nav-link">吃草日常</a></div><div class="nav-item"><a href="/modules/photography/" class="nav-link">无后期摄影</a></div> <a href="https://github.com/clinan/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/modules/technology/" aria-current="page" class="sidebar-link">目录</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>架构</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>SpringCloud</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/modules/technology/springcloud/dubbo-nacos.html" aria-current="page" class="active sidebar-link">Dubbo源码解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/technology/springcloud/dubbo-nacos.html#问题" class="sidebar-link">问题</a></li><li class="sidebar-sub-header"><a href="/modules/technology/springcloud/dubbo-nacos.html#用法" class="sidebar-link">用法</a></li><li class="sidebar-sub-header"><a href="/modules/technology/springcloud/dubbo-nacos.html#拓展点spi" class="sidebar-link">拓展点SPI</a></li><li class="sidebar-sub-header"><a href="/modules/technology/springcloud/dubbo-nacos.html#配置解析过程" class="sidebar-link">配置解析过程</a></li><li class="sidebar-sub-header"><a href="/modules/technology/springcloud/dubbo-nacos.html#服务暴露过程" class="sidebar-link">服务暴露过程</a></li><li class="sidebar-sub-header"><a href="/modules/technology/springcloud/dubbo-nacos.html#服务消费机制" class="sidebar-link">服务消费机制</a></li><li class="sidebar-sub-header"><a href="/modules/technology/springcloud/dubbo-nacos.html#线程模型" class="sidebar-link">线程模型</a></li><li class="sidebar-sub-header"><a href="/modules/technology/springcloud/dubbo-nacos.html#远程调用" class="sidebar-link">远程调用</a></li><li class="sidebar-sub-header"><a href="/modules/technology/springcloud/dubbo-nacos.html#dubbo集群容错" class="sidebar-link">dubbo集群容错</a></li><li class="sidebar-sub-header"><a href="/modules/technology/springcloud/dubbo-nacos.html#nacos集群" class="sidebar-link">Nacos集群</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux(Debian)</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="dubbo源码解析"><a href="#dubbo源码解析" class="header-anchor">#</a> Dubbo源码解析</h1> <p><img src="https://cdn.clinan.xyz/dubbo-framework.jpeg" alt=""></p> <h2 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h2> <ul><li>[x] dubbo SPI的实现细节。</li> <li>[x] dubbo中的使用spring的容器，如果和spring一起启动，两个容器是如何组合的。同过SpringExtensionFactory实现的。</li> <li>[ ] dubbo的服务暴露是如何实现的。如何变成invoker，exporter。</li> <li>[ ] 消费者的服务注入。</li> <li>[ ] 服务调用过程</li> <li>[ ] 注册中心的实现，心跳，数据接收，以及注册中心挂掉之后，服务如何表现</li> <li>[ ] 消费者什么时候从注册中心获取到元数据（注册+notify？）</li> <li>[ ] 注册中心心跳如何实现，netty实现的</li> <li>[ ] 注册中心的缓存如何实现，在AbstractRegistry里，有一个File的属性</li></ul> <h2 id="用法"><a href="#用法" class="header-anchor">#</a> 用法</h2> <ul><li><p>在消费者中，配置负载均衡和集群容错</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@DubboReference</span><span class="token punctuation">(</span>
            <span class="token comment">// 负载均衡策略</span>
            loadbalance <span class="token operator">=</span> <span class="token class-name">LeastActiveLoadBalance</span><span class="token punctuation">.</span>NAME<span class="token punctuation">,</span>
            <span class="token comment">// 集群容错策略</span>
            cluster <span class="token operator">=</span> <span class="token class-name">FailoverCluster</span><span class="token punctuation">.</span>NAME<span class="token punctuation">,</span>
            <span class="token comment">// 容错中的failover的重试次数</span>
            retries <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token comment">// 配置版本，在上线时做服务器增量更新很有用</span>
            version <span class="token operator">=</span> <span class="token string">&quot;2.0&quot;</span><span class="token punctuation">,</span>
            <span class="token comment">// 当一个接口有多种实现时，可以用 group 区分。</span>
            group <span class="token operator">=</span> <span class="token string">&quot;mygroup&quot;</span><span class="token punctuation">,</span>
            <span class="token comment">// 启动时不检查是否有服务可用</span>
            check <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">DemoService</span> demoService<span class="token punctuation">;</span>
</code></pre></div></li> <li><p>在服务提供者中配置权重，组，版本</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@DubboService</span><span class="token punctuation">(</span>weight <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> group <span class="token operator">=</span> <span class="token string">&quot;mygroup&quot;</span><span class="token punctuation">,</span> version <span class="token operator">=</span> <span class="token string">&quot;2.0&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">DemoService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div></li> <li><p>只订阅不注册</p> <p><code>dubbo.registry.address=nacos://localhost:8848?register=false</code></p></li> <li><p>静态服务，服务提供者初次注册时为禁用状态，需人工启用。断线时，将不会被自动删除，需人工禁用。</p> <p><code>dubbo.registry.address=nacos://localhost:8848?dynamic=false</code></p></li> <li><p>服务降级</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">RegistryFactory</span> registryFactory <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">RegistryFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Registry</span> registry <span class="token operator">=</span> registryFactory<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span>URL<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://localhost:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
registry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>URL<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;override://0.0.0.0/com.foo.BarService?category=configurators&amp;dynamic=false&amp;application=foo&amp;mock=force:return+null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h2 id="拓展点spi"><a href="#拓展点spi" class="header-anchor">#</a> 拓展点SPI</h2> <p>相对于java SPI的优势在于，不必实例化不需要用到的类。</p> <h3 id="spi"><a href="#spi" class="header-anchor">#</a> <code>@SPI</code></h3> <p>用于表示拓展点。一般备注在接口上。属性<code>name</code>表示默认的实现。如</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SPI</span><span class="token punctuation">(</span><span class="token string">&quot;netty&quot;</span><span class="token punctuation">)</span><span class="token comment">// 表示默认使用netty=org.apache.dubbo.remoting.transport.netty4.NettyTransporter</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Transporter</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Bind a server.
     *
     * @param url     server url
     * @param handler
     * @return server
     * @throws RemotingException
     * @see org.apache.dubbo.remoting.Transporters#bind(URL, ChannelHandler...)
     */</span>
    <span class="token annotation punctuation">@Adaptive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>SERVER_KEY<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>TRANSPORTER_KEY<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token class-name">RemotingServer</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Connect to a server.
     *
     * @param url     server url
     * @param handler
     * @return client
     * @throws RemotingException
     * @see org.apache.dubbo.remoting.Transporters#connect(URL, ChannelHandler...)
     */</span>
    <span class="token annotation punctuation">@Adaptive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>CLIENT_KEY<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>TRANSPORTER_KEY<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token class-name">Client</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="adaptive"><a href="#adaptive" class="header-anchor">#</a> <code>@Adaptive</code></h3> <p>拓展点自适应注解。如上面的代码。</p> <p>会根据多个参数，依次选择匹配的实现类。而不只是依靠<code>@SPI</code>中的默认实现。 会根据URL中的参数，查找<code>ExtensionLoader</code>。如果找到就使用对应的实现类。</p> <p>@Adaptive传入了两个Constants中的参数，它们的值分别是&quot;server”和“transporter”。当外部调用Transporter#bind方法时，会动态从传入的参数“URL”中提取“server”的value，如果能匹配上<strong>某个扩展实现类则直接使用对应的实现类</strong>；如果未匹配上，则继续通过第二个参数“transporter”提取value。如果都没匹配上，则抛出异常。也就是说，如果<code>@Adaptive中</code>传入了多个参数，则依次<strong>进行实现类的匹配</strong>，直到最后抛出异常。这种动态寻找实现类的方式比较灵活，但只能激活一个具体的实现类，如果需要多个实现类同时被激活，如Filter可以同时有多个过滤器；或者根据不同的条件，同时激活多个实现类，如何实现？这就涉及最后一个特性一一自动激活。</p> <p>加上<code>URL</code>和下面这些类(<code>Node</code>实现类)作为参数，才能在方法上使用<code>@Adaptive</code>。</p> <p><img src="https://cdn.clinan.xyz/dubbo-getUrl.png" alt=""></p> <h3 id="activate"><a href="#activate" class="header-anchor">#</a> <code>@Activate</code></h3> <p>激活多个拓展。</p> <h3 id="实现细节"><a href="#实现细节" class="header-anchor">#</a> 实现细节</h3> <p>会为每一个class对象，创建一个ExtensionLoader实例，缓存着cacheClass，adaptiveCache等。</p> <h4 id="adaptive的字节码生成"><a href="#adaptive的字节码生成" class="header-anchor">#</a> adaptive的字节码生成</h4> <p><strong>adaptive之后生成一次，会被缓存起来</strong></p> <p>由类<code>AdaptiveClassCodeGenerator</code>实现字节码的字符串构建。最后是由<code>javaassist</code>（默认）生成下面的类</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span>extension<span class="token punctuation">.</span></span><span class="token class-name">ExtensionLoader</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span><span class="token class-name">Exporter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span><span class="token class-name">Invoker</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span><span class="token class-name">Protocol</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span><span class="token class-name">RpcException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Protocol</span>$<span class="token class-name">Adaptive</span> <span class="token keyword">implements</span> <span class="token class-name">Protocol</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Exporter</span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span> arg0<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>RpcException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arg0 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;org.apache.dubbo.rpc.Invoker argument == null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arg0<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;org.apache.dubbo.rpc.Invoker argument getUrl() == null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">URL</span> url <span class="token operator">=</span> arg0<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> extName <span class="token operator">=</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;dubbo&quot;</span> <span class="token operator">:</span> url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>extName <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get extension (org.apache.dubbo.rpc.Protocol) name from url (&quot;</span> <span class="token operator">+</span> url<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;) use keys([protocol])&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Protocol</span> extension <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span>extName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> extension<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>arg0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Invoker</span> <span class="token function">refer</span><span class="token punctuation">(</span><span class="token class-name">Class</span> arg0<span class="token punctuation">,</span> <span class="token class-name">URL</span> arg1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arg1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;url == null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">URL</span> url <span class="token operator">=</span> arg1<span class="token punctuation">;</span>
        <span class="token class-name">String</span> extName <span class="token operator">=</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;dubbo&quot;</span> <span class="token operator">:</span> url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>extName <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get extension (org.apache.dubbo.rpc.Protocol) name from url (&quot;</span> <span class="token operator">+</span> url<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;) use keys([protocol])&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这个很重要，要从ExtensionLoader里面获取匹配extName的实现</span>
        <span class="token class-name">Protocol</span> extension <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span>extName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> extension<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>arg0<span class="token punctuation">,</span> arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="装饰类-wrap-细节"><a href="#装饰类-wrap-细节" class="header-anchor">#</a> 装饰类（wrap）细节</h4> <p><strong>重要的，每次获取实例的时候，都会重新装饰这个实例，装饰的结果并没有被缓存</strong></p> <p>如果没有加上@Wrapper注解，那么所有的wrapper类都会套（AOP）一层。</p> <p>装饰类判断</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
  * test if clazz is a wrapper class，
  * &lt;p&gt;
  *  下面这个注释说的很棒。
  * which has Constructor with given class type as its only argument
  */</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isWrapperClass</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    clazz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>装饰类实例过程</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>wrap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> wrapperClassesList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedWrapperClasses <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    wrapperClassesList<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>cachedWrapperClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>
    wrapperClassesList<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">WrapperComparator</span><span class="token punctuation">.</span>COMPARATOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span>wrapperClassesList<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>wrapperClassesList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// CORE_CODE 包装类实例，存在多次包装</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> wrapperClass <span class="token operator">:</span> wrapperClassesList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Wrapper</span> wrapper <span class="token operator">=</span> wrapperClass<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Wrapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper <span class="token operator">==</span> <span class="token keyword">null</span>
          <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token class-name">ArrayUtils</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">ArrayUtils</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">mismatches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;接口包装：&quot;</span><span class="token operator">+</span>type<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\t &quot;</span><span class="token operator">+</span>wrapperClass<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用构造方法实例化，并处理依赖注入</span>
        instance <span class="token operator">=</span> <span class="token function">injectExtension</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> wrapperClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="一般的调用流程是"><a href="#一般的调用流程是" class="header-anchor">#</a> 一般的调用流程是</h3> <ol><li><p>ExtensionLoader.getExtensionLoader(Protocol.class).getAdaptiveExtension();</p></li> <li><p>在生成的类里面，根据URL的规则进行Adaptive，这时候获得到的就是wrapper之后的对象。在这里每次调用的时候，都会重新wrapper一遍。</p> <p>Protocol extension = ExtensionLoader.getExtensionLoader(Protocol.class).getExtension(extName);</p></li> <li><p>调用就是</p></li></ol> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><h4 id="getextension流程"><a href="#getextension流程" class="header-anchor">#</a> getExtension流程</h4> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p>剩下的调用栈</p> <p><img src="https://cdn.clinan.xyz/getExtension.png" alt=""></p> <p>由此可以知道</p> <p>$Adaptive--&gt;getExtension（获取到的是包装类，需要依赖注入）--&gt;createExtension--&gt;injectExtension--&gt;objectFactory.getExtension--&gt;AdaptiveExtensionFactory.getExtension--&gt;SpiExtensionFactory.getAdapativeExtension--&gt;createAdativeExtension</p> <p>接下来在调用的时候，会根据Adaptive</p> <p>$Adaptive--&gt;getExtension--&gt;如果不是包装类，没有setter方法，就不会再执行injectExtension了</p> <h3 id="如何和spring容器结合"><a href="#如何和spring容器结合" class="header-anchor">#</a> 如何和Spring容器结合</h3> <p>通过<code>AdaptiveExtensionFactory</code>这个<code>ExtensionFactory</code>的默认实现，获取所有的可用<code>ExtensionFactory</code>，分别是<code>SPIExtensionFactory</code>和<code>SpringExtensionFactory</code>。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Adaptive</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdaptiveExtensionFactory</span> <span class="token keyword">implements</span> <span class="token class-name">ExtensionFactory</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExtensionFactory</span><span class="token punctuation">&gt;</span></span> factories<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">AdaptiveExtensionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里会获取所有的ExtensionFactory实现都整合到这里来，然后再递归遍历查找</span>
        <span class="token class-name">ExtensionLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExtensionFactory</span><span class="token punctuation">&gt;</span></span> loader <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">ExtensionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExtensionFactory</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExtensionFactory</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> name <span class="token operator">:</span> loader<span class="token punctuation">.</span><span class="token function">getSupportedExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>loader<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        factories <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 遍历查找</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ExtensionFactory</span> factory <span class="token operator">:</span> factories<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">T</span> extension <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>extension <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> extension<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>其中<code>SpringExtensionFactory</code>的实现如下</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 通过这个静态方法set Spring的ApplicationContext</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    CONTEXTS<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">)</span> context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerShutdownHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// see https://github.com/apache/dubbo/issues/7093</span>
        <span class="token class-name">DubboShutdownHook</span><span class="token punctuation">.</span><span class="token function">getDubboShutdownHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unregister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//SPI should be get from SpiExtensionFactory</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> type<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span>SPI<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> context <span class="token operator">:</span> CONTEXTS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">T</span> bean <span class="token operator">=</span> <span class="token function">getOptionalBean</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> name<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="配置解析过程"><a href="#配置解析过程" class="header-anchor">#</a> 配置解析过程</h2> <h3 id="xml解析"><a href="#xml解析" class="header-anchor">#</a> XML解析</h3> <p>dubbo的XML空间<code>dubbo-config/dubbo-config-spring/src/main/resources/META-INF/spring.handlers</code></p> <div class="language- extra-class"><pre class="language-text"><code>http\://dubbo.apache.org/schema/dubbo=org.apache.dubbo.config.spring.schema.DubboNamespaceHandler
http\://code.alibabatech.com/schema/dubbo=org.apache.dubbo.config.spring.schema.DubboNamespaceHandler
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DubboNamespaceHandler</span> <span class="token keyword">extends</span> <span class="token class-name">NamespaceHandlerSupport</span> <span class="token keyword">implements</span> <span class="token class-name">ConfigurableSourceBeanMetadataElement</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">Version</span><span class="token punctuation">.</span><span class="token function">checkDuplicate</span><span class="token punctuation">(</span><span class="token class-name">DubboNamespaceHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;application&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DubboBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token class-name">ApplicationConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;module&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DubboBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token class-name">ModuleConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;registry&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DubboBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token class-name">RegistryConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;config-center&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DubboBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token class-name">ConfigCenterBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;metadata-report&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DubboBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token class-name">MetadataReportConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;monitor&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DubboBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token class-name">MonitorConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;metrics&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DubboBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token class-name">MetricsConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;ssl&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DubboBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token class-name">SslConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;provider&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DubboBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token class-name">ProviderConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;consumer&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DubboBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;protocol&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DubboBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token class-name">ProtocolConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;service&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DubboBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token class-name">ServiceBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;reference&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DubboBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token class-name">ReferenceBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;annotation&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="注解解析"><a href="#注解解析" class="header-anchor">#</a> 注解解析</h3> <h2 id="服务暴露过程"><a href="#服务暴露过程" class="header-anchor">#</a> 服务暴露过程</h2> <p><img src="https://cdn.clinan.xyz/server-export.png" alt=""></p> <p>一个服务接口的暴露过程，主要分为两个步骤。</p> <ol><li>将持有的服务实例通过代理转为<code>Invoker</code>。</li> <li>然后通过具体的协议（protocol，比如 dubbo）转为<code>Exporter</code></li></ol> <p><strong>每个服务接口都会被转为一个<code>ServiceBean</code>的实例。<code>ServiceBean</code>继承于<code>ServiceConfig</code></strong>，主要的注册逻辑都在<code>ServiceConfig</code>中。</p> <h2 id="服务消费机制"><a href="#服务消费机制" class="header-anchor">#</a> 服务消费机制</h2> <p><img src="https://cdn.clinan.xyz/server_consumer.png" alt=""></p> <p>单个服务消费机制。主要分为两个部分。</p> <ol><li>把持有的服务实例根据协议（protocal）生成<code>Invoker</code>对象。</li> <li>通过动态代理，转为用户接口的实现类。这个实现类处理了网络连接，服务调用，重试等功能。</li></ol> <p>每个服务引用的接口都是<code>ReferenceBean</code>， <code>ReferenceBean#getObject()</code>方法是入口。继承于<code>ReferenceConfig</code></p> <h3 id="消费者代理流程"><a href="#消费者代理流程" class="header-anchor">#</a> 消费者代理流程</h3> <ol><li>ReferenceBean#getObject()</li> <li>org.apache.dubbo.config.ReferenceConfig#createProxy
<ol><li><code>REF_PROTOCOL.refer(interfaceClass, url);</code>根据Adaptive自适应，注册中心会直接跳转到RegistryProtocol#refer，直连会跳转到自适应的Protocol#refer，下面主要说注册中心
<ul><li>RegistryProtocol#refer
<ul><li>RegistryProtocol#doCreateInvoker里调用了directory.subscribe(toSubscribeUrl(urlToRegistry));在里面进行了registry#subscribe，把directory作为NotifyListener回调传进去。</li></ul></li></ul></li> <li>判断是否有多个注册中心，如果是则使用注册中心中的cluster参数进行自适应，默认为ZoneWareCluster(也是Invoker的实现类)。将多个Invokers封装成一个集群（Cluster）的Invoker，后续也在这个ClusterInvoker里进行路由和负载均衡。</li></ol></li> <li>PROXY_FACTORY#getProxy()创建代理</li> <li>getProxy(invoker, interfaces.toArray(new Class&lt;?&gt;[0]));
<ol><li>AbstractProxyFactory#getProxy(Invoker<T>, Class&lt;?&gt;[])调用JDK动态代理进行创建代理</T></li> <li>最后是new InvokerInvocationHandler(invoker)，给到JDK动态代理，<a href="https://github.com/Clinan/dubbo-2.7.13/blob/5b35bb0860d1c615842dcb261e09af354385ad4d/dubbo-rpc/dubbo-rpc-api/src/main/java/org/apache/dubbo/rpc/proxy/InvokerInvocationHandler.java#L66" target="_blank" rel="noopener noreferrer">invoke<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>方法用于代理回调。</li></ol></li></ol> <h2 id="线程模型"><a href="#线程模型" class="header-anchor">#</a> 线程模型</h2> <h4 id="配置-dubbo-中的线程模型"><a href="#配置-dubbo-中的线程模型" class="header-anchor">#</a> 配置 <code>Dubbo</code> 中的线程模型</h4> <ul><li><p>如果事件处理的逻辑能迅速完成，并且不会发起新的 IO 请求，比如只是在内存中记个标识，则直接在 IO 线程上处理更快，因为减少了线程池调度。</p></li> <li><p>但如果事件处理逻辑较慢，或者需要发起新的 IO 请求，比如需要查询数据库，则必须派发到线程池，否则 IO 线程阻塞，将导致不能接收其它请求。</p></li> <li><p>如果用 IO 线程处理事件，又在事件处理过程中发起新的 IO 请求，比如在连接事件中发起登录请求，会报“可能引发死锁”异常，但不会真死锁。</p></li></ul> <p>因此，需要通过不同的派发策略和不同的线程池配置的组合来应对不同的场景:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>protocol</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dubbo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">dispatcher</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>all<span class="token punctuation">&quot;</span></span> <span class="token attr-name">threadpool</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fixed<span class="token punctuation">&quot;</span></span> <span class="token attr-name">threads</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>100<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><h4 id="dispatcher"><a href="#dispatcher" class="header-anchor">#</a> Dispatcher</h4> <ul><li><code>all</code> 所有消息都派发到线程池，包括请求，响应，连接事件，断开事件，心跳等。</li> <li><code>direct</code> 所有消息都不派发到线程池，全部在 IO 线程上直接执行。</li> <li><code>message</code> 只有请求响应消息派发到线程池，其它连接断开事件，心跳等消息，直接在 IO 线程上执行。</li> <li><code>execution</code> 只有请求消息派发到线程池，不含响应，响应和其它连接断开事件，心跳等消息，直接在 IO 线程上执行。</li> <li><code>connection</code> 在 IO 线程上，将连接断开事件放入队列，有序逐个执行，其它消息派发到线程池。</li></ul> <h4 id="threadpool"><a href="#threadpool" class="header-anchor">#</a> <code>ThreadPool</code></h4> <ul><li><code>fixed</code> 固定大小线程池，启动时建立线程，不关闭，一直持有。(缺省)</li> <li><code>cached</code> 缓存线程池，空闲一分钟自动删除，需要时重建。</li> <li><code>limited</code> 可伸缩线程池，但池中的线程数只会增长不会收缩。只增长不收缩的目的是为了避免收缩时突然来了大流量引起的性能问题。</li> <li><code>eager</code> 优先创建<code>Worker</code>线程池。在任务数量大于<code>corePoolSize</code>但是小于<code>maximumPoolSize</code>时，优先创建<code>Worker</code>来处理任务。当任务数量大于<code>maximumPoolSize</code>时，将任务放入阻塞队列中。阻塞队列充满时抛出<code>RejectedExecutionException</code>。(相比于<code>cached</code>:<code>cached</code>在任务数量超过<code>maximumPoolSize</code>时直接抛出异常而不是将任务放入阻塞队列)</li></ul> <h2 id="远程调用"><a href="#远程调用" class="header-anchor">#</a> 远程调用</h2> <p><img src="https://cdn.clinan.xyz/dubbo-invoke.png" alt=""></p> <h3 id="channelhandler"><a href="#channelhandler" class="header-anchor">#</a> <code>channelHandler</code></h3> <p>服务提供者和消费者会保持长连接，都会有一个后台线程进行</p> <h2 id="dubbo集群容错"><a href="#dubbo集群容错" class="header-anchor">#</a> <code>dubbo</code>集群容错</h2> <p>工作流程</p> <ol><li><p>生成<code>Invoker</code>对象，不同的<code>Cluster</code>实现会生成不同类型的<code>ClusterInvoker</code>对象并返回。然后调用<code>ClusterInvoker</code>的<code>invoker</code>方法，正式开始调用流程</p></li> <li><p>获取可调用的服务列表，再路由规则匹配，返回符合的服务列表</p></li> <li><p>做负载均衡 。跟进用户的配置，调用<code>ExtensionLoader</code>获取不同的负载均衡策略的拓展点实现。然后做一些后置操作。如果是异步调用则设置调用编号。接着调用子实现的<code>doInvoke</code>方法，根据具体的负载均衡策略选出一个可以调用的服务。</p></li> <li><p>做<code>RPC</code>调用。首先保存每次调用的<code>Invoker</code>到<code>RPC</code>上下文，并作<code>RPC</code>调用。然后处理调用结果。</p></li></ol> <p><img src="https://cdn.clinan.xyz/dubbo-cluster.png" alt=""></p> <h4 id="failover"><a href="#failover" class="header-anchor">#</a> <code>Failover</code></h4> <p>失败可以重试，可以设置重试次数</p> <h4 id="failfast"><a href="#failfast" class="header-anchor">#</a> <code>failfast</code></h4> <p>快速失败，只要失败一次就直接报错，通常用于非幂等性的写操作，比如新增记录。</p> <h4 id="failsafe"><a href="#failsafe" class="header-anchor">#</a> <code>failsafe</code></h4> <p>失败不报错，直接忽略。通常用于日志等不重要信息的集群。</p> <h4 id="failback"><a href="#failback" class="header-anchor">#</a> <code>failback</code></h4> <p>失败自动恢复，后台记录失败请求，定时重发。通常用于消息通知等操作。</p> <h4 id="forking-cluster"><a href="#forking-cluster" class="header-anchor">#</a> Forking Cluster</h4> <p>并行调用多个服务器，只要一个成功即返回。通常用于实时性要求较高的读操作，但需要浪费更多服务资源。可通过 <code>forks=&quot;2&quot;</code> 来设置最大并行数。</p> <h4 id="broadcast-cluster"><a href="#broadcast-cluster" class="header-anchor">#</a> Broadcast Cluster</h4> <p>广播调用所有提供者，逐个调用，任意一台报错则<a href="http://dubbo.io/books/dubbo-user-book/demos/fault-tolerent-strategy.html#fn_2" target="_blank" rel="noopener noreferrer">报错 <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。通常用于通知所有提供者更新缓存或日志等本地资源信息。</p> <h3 id="负载均衡"><a href="#负载均衡" class="header-anchor">#</a> 负载均衡</h3> <h4 id="randomloadbalance"><a href="#randomloadbalance" class="header-anchor">#</a> <code>RandomLoadBalance</code></h4> <p>随机，按<strong>权重设置</strong>随机概率。如果刚启动机器，权重不高，需要预热好，慢慢请求的权重就会达到配置的权重</p> <h4 id="roundrobinloadbalance"><a href="#roundrobinloadbalance" class="header-anchor">#</a> <code>RoundRobinLoadBalance</code></h4> <p>轮询，按公约后的权重设置轮询比例。存在慢点提供者累积请求的问题。</p> <p>权重轮询，有普通权重轮询和平滑权重轮询。</p> <h4 id="leastactiveloadbalance"><a href="#leastactiveloadbalance" class="header-anchor">#</a> <code>LeastActiveLoadBalance</code></h4> <p>最少调用次数，如果活跃数相同则随机调用，活跃数指调用前后计数差，使慢的收到更少请求，因为越慢的提供者的调用前后的计数差会越大</p> <p>可以看出是Random负载均衡的<strong>加强版</strong>，</p> <h4 id="consistenthashloadbalance"><a href="#consistenthashloadbalance" class="header-anchor">#</a> <code>ConsistentHashLoadBalance</code></h4> <p>一致性Hash，相同参数的请求总是发到同一提供者。当某一台提供者挂掉，原本发给该提供者的请求，基于虚拟节点，会平摊到其他提供者，不会引起剧烈变动</p> <h1 id="nacos"><a href="#nacos" class="header-anchor">#</a> Nacos</h1> <h2 id="nacos集群"><a href="#nacos集群" class="header-anchor">#</a> Nacos集群</h2> <h3 id="选举算法"><a href="#选举算法" class="header-anchor">#</a> 选举算法</h3> <p>Nacos集群采用 <strong>raft</strong> 算法来实现，它是相对zookeeper的选举算法较为简单的一种。选举算法的核心在 RaftCore 中，包括数据的处理和数据同步。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/clinan/blog/edit/master/modules/technology/springcloud/dubbo-nacos.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新于:</span> <span class="time">8/11/2021, 10:10:40 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/modules/technology/spring/spring-mvc.html" class="prev">SpringMVC的启动流程</a></span> <span class="next"><a href="/modules/technology/linux-server/rasperry_init.html">树莓派</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c387313f.js" defer></script><script src="/assets/js/2.07d632c5.js" defer></script><script src="/assets/js/76.fb7ef46f.js" defer></script>
  </body>
</html>
